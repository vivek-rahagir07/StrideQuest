<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StrideQuest | Pro GPS Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --accent: #8b5cf6;
            --dark: #020617;
            --surface: #0f172a;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--dark); color: white; -webkit-tap-highlight-color: transparent; }
        
        /* Smooth screen transitions */
        .screen { display: none; opacity: 0; transition: opacity 0.4s ease-in-out; }
        .screen.active { display: flex; opacity: 1; }
        
        /* Animations */
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-pulse { animation: pulse-ring 2s infinite; }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }

        @keyframes slide-in-top {
            0% { transform: translateY(-100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: var(--dark); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }

        /* Glassmorphism */
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 255, 255, 0.1); }

        /* Canvas */
        canvas { width: 100% !important; height: auto !important; }
        
        /* Confetti Canvas */
        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 100; width: 100vw; height: 100vh; }

        /* Toast Notification */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: none;
            animation: slide-in-top 0.3s ease-out;
        }

        /* Chat Specific */
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 16px; font-size: 0.9rem; line-height: 1.4; animation: slide-up 0.3s ease-out; }
        .chat-user { align-self: flex-end; background-color: #10b981; color: #020617; border-bottom-right-radius: 4px; }
        .chat-bot { align-self: flex-start; background-color: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.1); color: #e2e8f0; border-bottom-left-radius: 4px; }
        .typing-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background-color: #94a3b8; animation: typing 1.4s infinite ease-in-out both; margin: 0 2px; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-100 selection:bg-emerald-500 selection:text-white">

    <canvas id="confetti-canvas"></canvas>

    <!-- Toast Notification -->
    <div id="toast" class="bg-emerald-500 text-white px-6 py-3 rounded-full font-bold shadow-2xl flex items-center gap-2 border border-white/20">
        <i data-lucide="flag" class="w-5 h-5 fill-current"></i>
        <span id="toast-message">Notification</span>
    </div>

    <!-- Header -->
    <header class="bg-slate-900/80 backdrop-blur-md border-b border-white/5 p-4 flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-2 text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400 font-black text-xl tracking-tight">
            <i data-lucide="zap" class="text-emerald-400 fill-emerald-400/20"></i>
            <span>STRIDE<span class="text-white font-light">QUEST</span></span>
        </div>
        <div class="flex items-center gap-2 bg-slate-800/50 border border-white/5 px-3 py-1 rounded-full text-sm shadow-inner">
            <i data-lucide="trophy" class="w-4 h-4 text-yellow-400 fill-yellow-400/20"></i>
            <span id="user-xp" class="font-mono font-bold text-yellow-100">0</span> <span class="text-xs text-slate-400">XP</span>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 relative overflow-hidden bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black flex flex-col">
        
        <!-- SCREEN 1: DASHBOARD -->
        <div id="screen-dashboard" class="screen active flex-col p-6 gap-6 overflow-y-auto pb-28 w-full max-w-lg mx-auto h-full">
            
            <!-- Daily Challenge Card -->
            <div class="relative group shrink-0">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl blur opacity-75 group-hover:opacity-100 transition duration-1000 group-hover:duration-200 animate-tilt"></div>
                <div class="relative bg-slate-900 rounded-2xl p-6 shadow-2xl overflow-hidden border border-white/10">
                    <div class="absolute top-0 right-0 p-4 opacity-10 rotate-12 transform scale-150">
                        <i data-lucide="target" class="w-32 h-32 text-indigo-400"></i>
                    </div>
                    
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-xs font-bold uppercase tracking-widest text-indigo-400 mb-1">Daily Target</h2>
                            <div id="challenge-text" class="text-2xl font-black leading-tight pr-4">Loading challenge...</div>
                        </div>
                        <div class="bg-indigo-500/20 px-3 py-1 rounded-full border border-indigo-500/30 text-indigo-300 text-xs font-bold whitespace-nowrap">
                            <i data-lucide="star" class="w-3 h-3 inline mr-1"></i>
                            <span id="challenge-reward">-- XP</span>
                        </div>
                    </div>

                    <button id="btn-start-run" class="w-full bg-white text-slate-900 font-bold py-4 px-6 rounded-xl shadow-[0_0_20px_rgba(255,255,255,0.3)] hover:shadow-[0_0_30px_rgba(255,255,255,0.5)] active:scale-[0.98] transition-all flex items-center justify-center gap-3 group/btn">
                        <span class="tracking-wider">START RUN</span>
                        <i data-lucide="arrow-right" class="group-hover/btn:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-4 animate-slide-up shrink-0" style="animation-delay: 0.1s;">
                <div class="glass p-5 rounded-2xl">
                    <div class="flex items-center gap-2 mb-2 text-emerald-400">
                        <i data-lucide="map" class="w-4 h-4"></i>
                        <span class="text-xs font-bold uppercase tracking-wider">Distance</span>
                    </div>
                    <div class="text-2xl font-mono font-bold text-white"><span id="total-dist">0.0</span> <span class="text-sm text-slate-500 font-sans">km</span></div>
                </div>
                <div class="glass p-5 rounded-2xl">
                    <div class="flex items-center gap-2 mb-2 text-orange-400">
                        <i data-lucide="flame" class="w-4 h-4"></i>
                        <span class="text-xs font-bold uppercase tracking-wider">Calories</span>
                    </div>
                    <div class="text-2xl font-mono font-bold text-white" id="total-cals">0</div>
                </div>
            </div>

            <!-- History List -->
            <div class="flex-1 animate-slide-up" style="animation-delay: 0.2s;">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                    Recent Activity
                </h3>
                <div id="history-list" class="space-y-3 pb-4">
                    <!-- History items injected here -->
                    <div class="text-center text-slate-600 py-10 glass rounded-xl border-dashed border-slate-700">
                        <i data-lucide="footprints" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                        <p class="text-sm">No runs recorded yet.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 2: ACTIVE RUN -->
        <div id="screen-run" class="screen flex-col items-center justify-center min-h-full p-6 bg-black absolute inset-0 z-20">
            
            <!-- Ambient Background -->
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-900/20 via-black to-black pointer-events-none"></div>

            <!-- GPS Status -->
            <div class="absolute top-6 left-6 right-6 flex justify-between items-center z-30">
                <div class="glass px-3 py-1 rounded-full flex items-center gap-2">
                    <div id="gps-status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <span id="gps-status-text" class="text-[10px] uppercase font-bold tracking-widest text-slate-300">Locating...</span>
                </div>
                <div class="text-xs font-mono text-slate-500" id="current-time">--:--</div>
            </div>

            <!-- Main Metrics -->
            <div class="relative z-10 flex flex-col items-center w-full max-w-md">
                
                <div class="mb-12 text-center animate-float">
                    <div class="text-slate-500 text-xs font-bold uppercase tracking-[0.2em] mb-4">Total Time</div>
                    <!-- Added visual feedback for paused state -->
                    <div id="timer-display" class="text-7xl font-mono font-black tracking-tighter text-white tabular-nums drop-shadow-[0_0_15px_rgba(255,255,255,0.1)] transition-colors duration-300">00:00</div>
                    <div id="auto-pause-indicator" class="text-yellow-500 text-xs font-bold uppercase tracking-widest mt-2 hidden animate-pulse">Auto-Paused</div>
                </div>

                <div class="grid grid-cols-2 gap-x-8 gap-y-10 w-full mb-16">
                    <div class="text-center group">
                        <div class="text-slate-500 text-[10px] uppercase font-bold tracking-widest mb-1 group-hover:text-emerald-400 transition-colors">Distance</div>
                        <div class="text-4xl font-black text-emerald-400"><span id="run-dist">0.00</span><span class="text-base font-medium text-emerald-600 ml-1">km</span></div>
                    </div>
                    <div class="text-center group">
                        <div class="text-slate-500 text-[10px] uppercase font-bold tracking-widest mb-1 group-hover:text-blue-400 transition-colors">Pace</div>
                        <div class="text-4xl font-black text-blue-400"><span id="run-pace">--:--</span><span class="text-base font-medium text-blue-600 ml-1">/km</span></div>
                    </div>
                    <div class="text-center group">
                        <div class="text-slate-500 text-[10px] uppercase font-bold tracking-widest mb-1 group-hover:text-purple-400 transition-colors">Calories</div>
                        <div class="text-3xl font-bold text-purple-400" id="run-cals">0</div>
                    </div>
                    <div class="text-center group">
                        <div class="text-slate-500 text-[10px] uppercase font-bold tracking-widest mb-1 group-hover:text-orange-400 transition-colors">Speed</div>
                        <div class="text-3xl font-bold text-orange-400"><span id="run-speed">0.0</span><span class="text-sm font-medium text-orange-600 ml-1">km/h</span></div>
                    </div>
                </div>

                <!-- Stop Button -->
                <button id="btn-stop-run" class="group relative w-24 h-24 flex items-center justify-center">
                    <div class="absolute inset-0 bg-red-500 rounded-full opacity-20 group-hover:opacity-40 transition-opacity animate-ping"></div>
                    <div class="relative w-20 h-20 bg-gradient-to-br from-red-500 to-rose-600 rounded-full shadow-[0_0_30px_rgba(244,63,94,0.4)] flex items-center justify-center hover:scale-105 active:scale-95 transition-transform">
                        <div class="w-8 h-8 bg-white rounded-md"></div>
                    </div>
                </button>
                <div class="mt-6 text-slate-500 text-xs font-medium tracking-wide uppercase opacity-0 animate-[fadeIn_2s_ease-in_forwards]">Tap to Finish</div>
            </div>
        </div>

        <!-- SCREEN 3: SUMMARY -->
        <div id="screen-summary" class="screen flex-col p-6 min-h-full pb-20 w-full max-w-lg mx-auto overflow-y-auto">
            
            <div class="text-center mb-6 animate-slide-up">
                <div class="inline-block p-3 rounded-full bg-emerald-500/10 mb-3 border border-emerald-500/20">
                    <i data-lucide="check" class="w-8 h-8 text-emerald-400"></i>
                </div>
                <h2 class="text-3xl font-black text-white mb-1">Run Complete!</h2>
                <div id="challenge-result-box" class="hidden items-center justify-center gap-2 text-yellow-400 text-sm font-bold mt-2 animate-bounce">
                    <i data-lucide="star" class="fill-current w-4 h-4"></i>
                    <span>Challenge Crushed! +<span id="bonus-xp-display">0</span> XP</span>
                </div>
            </div>

            <!-- Stats & Photo Section -->
            <div class="glass rounded-2xl p-4 border border-slate-700/50 flex flex-col gap-4 animate-slide-up" style="animation-delay: 0.1s;">
                
                <!-- Quick Stats Grid -->
                <div class="grid grid-cols-3 divide-x divide-white/10 text-center pb-4 border-b border-white/5">
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold">Dist</div>
                        <div class="text-lg font-bold text-white" id="summary-dist">0.00</div>
                    </div>
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold">Time</div>
                        <div class="text-lg font-bold text-white" id="summary-time">00:00</div>
                    </div>
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold">Cals</div>
                        <div class="text-lg font-bold text-white" id="summary-cals">0</div>
                    </div>
                </div>

                <!-- Canvas Preview -->
                <div class="relative w-full aspect-[4/5] bg-black rounded-xl overflow-hidden group border border-slate-800 shadow-2xl">
                    <canvas id="share-canvas" class="w-full h-full object-cover"></canvas>
                    
                    <!-- Upload overlay (visible when no image or on hover) -->
                    <div id="upload-overlay" class="absolute inset-0 bg-slate-900/80 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-900/60 transition-colors z-10" onclick="document.getElementById('photo-upload').click()">
                        <i data-lucide="camera" class="w-10 h-10 text-white mb-3"></i>
                        <p class="text-xs text-slate-300 font-bold uppercase tracking-widest text-center px-4">Tap to add photo<br>& Overlay Route</p>
                    </div>
                    <input type="file" id="photo-upload" accept="image/*" class="hidden">
                </div>

                <!-- Actions -->
                <div class="grid grid-cols-2 gap-3 mt-2">
                    <button id="btn-download" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold py-3 rounded-xl flex justify-center items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="download" class="w-4 h-4"></i> Save
                    </button>
                    <button id="btn-close-summary" class="bg-slate-700 hover:bg-slate-600 text-white text-sm font-bold py-3 rounded-xl transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- SCREEN 4: PROFILE -->
        <div id="screen-profile" class="screen flex-col p-6 min-h-full pb-28 w-full max-w-lg mx-auto overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6">Settings & Profile</h2>
            
            <div class="glass p-6 rounded-2xl mb-6 space-y-4">
                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold block mb-2">Display Name</label>
                    <input type="text" id="input-name" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-emerald-500 transition-colors" placeholder="Runner">
                </div>
                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold block mb-2">Weight (kg) <span class="text-slate-500 normal-case font-normal">(for calorie calc)</span></label>
                    <input type="number" id="input-weight" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-emerald-500 transition-colors" placeholder="70">
                </div>
                <button id="btn-save-profile" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg mt-2">Save Changes</button>
            </div>

            <div class="glass p-6 rounded-2xl">
                <h3 class="font-bold mb-4 text-slate-300">Statistics</h3>
                <div class="flex justify-between items-center py-2 border-b border-slate-700/50">
                    <span class="text-slate-500">Total Runs</span>
                    <span class="text-white font-mono" id="profile-total-runs">0</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-slate-700/50">
                    <span class="text-slate-500">Total XP</span>
                    <span class="text-yellow-400 font-mono" id="profile-xp">0</span>
                </div>
                <button onclick="localStorage.clear(); window.location.reload();" class="w-full mt-6 text-xs text-red-500 hover:text-red-400 uppercase tracking-widest font-bold py-3 border border-red-500/20 rounded-lg">Reset All Data</button>
            </div>
        </div>

        <!-- SCREEN 5: AI COACH CHAT -->
        <div id="screen-chat" class="screen flex-col min-h-full w-full max-w-lg mx-auto relative h-full">
            <div class="p-4 bg-slate-900/90 backdrop-blur border-b border-white/5 sticky top-0 z-10 shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-emerald-400 to-cyan-400 flex items-center justify-center shadow-lg shadow-emerald-500/20">
                        <i data-lucide="bot" class="w-6 h-6 text-slate-900"></i>
                    </div>
                    <div>
                        <h2 class="font-bold text-white leading-none">Coach Stride</h2>
                        <div class="flex items-center gap-1.5 mt-1 text-[10px] text-emerald-400 font-bold uppercase tracking-wider">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                            Online & Ready
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto pb-28">
                <!-- Intro Message -->
                <div class="flex gap-3 chat-bubble chat-bot">
                    <div class="flex-1">
                        Hello! I'm Coach Stride. I can help with running tips, nutrition advice, gear recommendations, and recovery strategies. Ask me anything!
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-slate-900 border-t border-white/5 backdrop-blur-md shrink-0 mb-[70px]">
                <form id="chat-form" class="flex gap-2 relative">
                    <input type="text" id="chat-input" class="flex-1 bg-slate-800 border border-slate-700 text-white text-sm rounded-full pl-5 pr-4 py-3.5 focus:outline-none focus:border-emerald-500 transition-colors shadow-inner" placeholder="Ask about warmups, diet, pain..." autocomplete="off">
                    <button type="submit" class="w-12 h-12 bg-emerald-500 rounded-full flex items-center justify-center text-slate-900 hover:bg-emerald-400 transition-all active:scale-95 shadow-lg shadow-emerald-500/20 shrink-0">
                        <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
                    </button>
                </form>
            </div>
        </div>

    </main>

    <!-- Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 glass-panel pb-safe pt-2 px-6 flex justify-between items-end z-50">
        <button class="nav-btn active p-3 w-16 flex flex-col items-center gap-1 text-slate-500 transition-colors" data-target="dashboard">
            <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">Run</span>
        </button>

        <button class="nav-btn p-3 w-16 flex flex-col items-center gap-1 text-slate-500 transition-colors" data-target="chat">
            <i data-lucide="message-square-more" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">Coach</span>
        </button>
        
        <!-- Floating Action Button effect for center -->
        <div class="relative -top-5 mx-2">
            <button id="nav-btn-center" class="w-14 h-14 bg-emerald-500 rounded-full shadow-[0_0_20px_rgba(16,185,129,0.4)] flex items-center justify-center text-white hover:bg-emerald-400 transition-all hover:scale-105 active:scale-95" onclick="document.getElementById('btn-start-run').click()">
                <i data-lucide="play" class="w-6 h-6 fill-current ml-1"></i>
            </button>
        </div>

        <!-- Spacer for center button balance if needed, but flex-between handles it with margins -->
        
        <button class="nav-btn p-3 w-16 flex flex-col items-center gap-1 text-slate-500 transition-colors" data-target="profile">
            <i data-lucide="user" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">Profile</span>
        </button>
    </nav>

    <script>
        // --- CONFIG & STATE ---
        const CONFIG = {
            MET_RUNNING: 9.8, // Approximate MET for moderate running
            DEFAULT_WEIGHT: 70, // kg
            MIN_MOVEMENT_SPEED: 0.8 // m/s (approx 2.9 km/h) below this is considered "stopped"
        };

        const state = {
            isRunning: false,
            isAutoPaused: false, // Auto-pause state
            lowSpeedCounter: 0,  // Counts stationary readings
            startTime: 0,
            elapsedTime: 0,
            distance: 0,
            calories: 0,
            coords: [], // Array of {lat, lng}
            markers: [], // Array of {lat, lng, label} for 1km flags
            lastKmMarker: 0, // Last km milestone reached
            watchId: null,
            wakeLock: null,
            
            // Persistent Data
            totalXP: 0,
            runHistory: [],
            userWeight: 70,
            userName: 'Runner',
            currentChallenge: null,
            lastPosition: null
        };

        // --- DOM ELEMENTS ---
        const ui = {
            screens: {
                dashboard: document.getElementById('screen-dashboard'),
                run: document.getElementById('screen-run'),
                summary: document.getElementById('screen-summary'),
                profile: document.getElementById('screen-profile'),
                chat: document.getElementById('screen-chat')
            },
            navBtns: document.querySelectorAll('.nav-btn'),
            
            // Dashboard
            xp: document.getElementById('user-xp'),
            totalDist: document.getElementById('total-dist'),
            totalCals: document.getElementById('total-cals'),
            historyList: document.getElementById('history-list'),
            challengeText: document.getElementById('challenge-text'),
            challengeReward: document.getElementById('challenge-reward'),

            // Run
            timer: document.getElementById('timer-display'),
            autoPauseIndicator: document.getElementById('auto-pause-indicator'),
            runDist: document.getElementById('run-dist'),
            runPace: document.getElementById('run-pace'),
            runCals: document.getElementById('run-cals'),
            runSpeed: document.getElementById('run-speed'),
            gpsDot: document.getElementById('gps-status-dot'),
            gpsText: document.getElementById('gps-status-text'),
            
            // Summary
            summaryDist: document.getElementById('summary-dist'),
            summaryTime: document.getElementById('summary-time'),
            summaryCals: document.getElementById('summary-cals'),
            bonusXp: document.getElementById('bonus-xp-display'),
            challengeBox: document.getElementById('challenge-result-box'),
            canvas: document.getElementById('share-canvas'),
            photoInput: document.getElementById('photo-upload'),
            uploadOverlay: document.getElementById('upload-overlay'),
            btnDownload: document.getElementById('btn-download'),
            
            // Profile
            inputName: document.getElementById('input-name'),
            inputWeight: document.getElementById('input-weight'),
            profileRuns: document.getElementById('profile-total-runs'),
            profileXp: document.getElementById('profile-xp'),
            
            // Toast
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toast-message'),

            // Chat
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            chatMessages: document.getElementById('chat-messages')
        };

        // --- CHAT KNOWLEDGE BASE ---
        const chatDB = [
            {
                keywords: ['hydration', 'water', 'drink', 'thirsty'],
                response: "Hydration is key! Drink 500ml of water about 2 hours before a long run. During runs longer than an hour, aim for sips every 20 minutes. Don't forget to rehydrate after you finish!"
            },
            {
                keywords: ['food', 'eat', 'nutrition', 'diet', 'protein', 'carb'],
                response: "Fuel your runs with complex carbs (oats, pasta, rice) for energy. After running, consume protein (chicken, eggs, tofu) within 30 minutes to help muscle repair. Bananas are a great pre-run snack!"
            },
            {
                keywords: ['stretch', 'warm', 'cool', 'tight', 'flexible'],
                response: "Always warm up with dynamic stretches (leg swings, high knees) to get blood flowing. Save static stretching (holding a pose) for your cool-down to improve flexibility and reduce soreness."
            },
            {
                keywords: ['pain', 'hurt', 'injury', 'knee', 'shin', 'sore'],
                response: "Listen to your body. Sharp pain means STOP. For general soreness, Rest, Ice, Compression, and Elevation (RICE) works wonders. If pain persists for more than 3 days, see a professional."
            },
            {
                keywords: ['shoe', 'gear', 'wear', 'clothes', 'socks'],
                response: "Good shoes are your most important gear! Replace them every 500-800 km. Wear moisture-wicking fabrics (avoid cotton) to prevent chafing and stay cool."
            },
            {
                keywords: ['weight', 'fat', 'loss', 'burn'],
                response: "Running burns significant calories! To lose weight, combine consistent running (3-4 times/week) with a slight caloric deficit. Consistency beats intensity for long-term results."
            },
            {
                keywords: ['fast', 'speed', 'pace', 'improve'],
                response: "To get faster, try interval training: alternate between 1 minute of hard running and 2 minutes of jogging. Also, don't neglect your long, slow runsâ€”they build the endurance base you need for speed."
            },
            {
                keywords: ['tired', 'motivat', 'lazy', 'give up'],
                response: "Every runner has bad days. The hardest step is often the one out the door. Try putting on your running clothes; usually, the motivation follows. You got this!"
            },
            {
                keywords: ['hello', 'hi', 'hey'],
                response: "Hi there! I'm ready to help you hit your goals. What's on your mind today?"
            },
            {
                keywords: ['thank', 'thx'],
                response: "You're welcome! Keep up the great work!"
            }
        ];

        // --- INITIALIZATION ---
        function init() {
            lucide.createIcons();
            loadData();
            generateDailyChallenge();
            updateDashboard();
            setupNavigation();

            // Core Event Listeners
            document.getElementById('btn-start-run').addEventListener('click', startRun);
            document.getElementById('btn-stop-run').addEventListener('click', stopRun);
            document.getElementById('btn-close-summary').addEventListener('click', () => switchScreen('dashboard'));
            document.getElementById('btn-save-profile').addEventListener('click', saveProfile);
            document.getElementById('btn-download').addEventListener('click', downloadCard);
            
            ui.photoInput.addEventListener('change', handlePhotoUpload);
            ui.chatForm.addEventListener('submit', handleChatSubmit);

            // Time updater for run screen
            setInterval(() => {
                const now = new Date();
                const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                const el = document.getElementById('current-time');
                if(el) el.innerText = timeStr;
            }, 1000);
        }

        // --- NAVIGATION & UI ---
        function setupNavigation() {
            ui.navBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = btn.dataset.target;
                    
                    // Prevent nav if running
                    if(state.isRunning) return;

                    // Visual Update
                    ui.navBtns.forEach(b => {
                        b.classList.remove('text-emerald-400', 'active');
                        b.classList.add('text-slate-500');
                    });
                    btn.classList.remove('text-slate-500');
                    btn.classList.add('text-emerald-400', 'active');
                    
                    switchScreen(target);
                });
            });
        }

        function switchScreen(screenName) {
            Object.values(ui.screens).forEach(el => el.classList.remove('active'));
            ui.screens[screenName].classList.add('active');
            
            // Refresh icons or specific screen data
            if(screenName === 'dashboard') updateDashboard();
            if(screenName === 'profile') loadProfileUI();
            if(screenName === 'chat') {
                setTimeout(() => ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight, 100);
            }
        }

        function showToast(msg) {
            ui.toastMsg.innerText = msg;
            ui.toast.style.display = 'flex';
            setTimeout(() => {
                ui.toast.style.display = 'none';
            }, 3000);
        }

        // --- CHAT LOGIC ---
        function handleChatSubmit(e) {
            e.preventDefault();
            const text = ui.chatInput.value.trim();
            if(!text) return;

            // 1. User Message
            appendMessage('user', text);
            ui.chatInput.value = '';

            // 2. Typing Indicator
            const typingId = showTyping();
            
            // 3. Process Response
            setTimeout(() => {
                removeTyping(typingId);
                const response = findBestResponse(text);
                appendMessage('bot', response);
            }, 800 + Math.random() * 800); // Simulate network delay
        }

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex gap-3 chat-bubble ${role === 'user' ? 'chat-user ml-auto' : 'chat-bot'}`;
            
            // For bot, add icon if desired, keeping simple text bubble for now
            div.innerHTML = text;
            
            ui.chatMessages.appendChild(div);
            ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;
        }

        function showTyping() {
            const div = document.createElement('div');
            const id = 'typing-' + Date.now();
            div.id = id;
            div.className = 'flex gap-3 chat-bubble chat-bot w-16 items-center justify-center';
            div.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
            ui.chatMessages.appendChild(div);
            ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;
            return id;
        }

        function removeTyping(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        function findBestResponse(input) {
            const lowerInput = input.toLowerCase();
            
            // Look for match in DB
            for(const item of chatDB) {
                if(item.keywords.some(k => lowerInput.includes(k))) {
                    return item.response;
                }
            }
            
            // Fallbacks
            const fallbacks = [
                "That's an interesting running topic! Could you be more specific?",
                "I'm mostly an expert on running, nutrition, and gear. Can you rephrase that?",
                "I'm training hard to learn more. For now, try asking about diet, shoes, or warmups!",
                "Keep going! Running is as much mental as it is physical."
            ];
            return fallbacks[Math.floor(Math.random() * fallbacks.length)];
        }

        // --- CORE RUN LOGIC ---
        function startRun() {
            if (state.isRunning) return;
            
            if (!navigator.geolocation) {
                alert("Geolocation required.");
                return;
            }

            requestWakeLock();
            
            state.isRunning = true;
            state.isAutoPaused = false;
            state.startTime = Date.now();
            state.elapsedTime = 0;
            state.distance = 0;
            state.calories = 0;
            state.coords = [];
            state.markers = [];
            state.lastPosition = null;
            state.lastKmMarker = 0;
            state.lowSpeedCounter = 0;

            // Reset UI
            ui.runDist.innerText = "0.00";
            ui.runPace.innerText = "--:--";
            ui.runCals.innerText = "0";
            ui.runSpeed.innerText = "0.0";
            ui.timer.innerText = "00:00";
            ui.timer.classList.remove('text-yellow-500');
            ui.autoPauseIndicator.classList.add('hidden');
            
            switchScreen('run');
            document.querySelector('nav').style.display = 'none'; // Hide nav during run

            // Timer Loop
            state.timerInterval = setInterval(updateRunState, 1000);

            // GPS Loop
            state.watchId = navigator.geolocation.watchPosition(
                handlePositionSuccess, 
                handlePositionError, 
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        function stopRun() {
            if (!state.isRunning) return;
            
            state.isRunning = false;
            clearInterval(state.timerInterval);
            navigator.geolocation.clearWatch(state.watchId);
            if (state.wakeLock) state.wakeLock.release();

            // Final Calculation
            const distKm = state.distance / 1000;
            
            // Check Challenge
            let earnedXP = Math.floor(distKm * 20); // 20 XP per km base
            let challengeComplete = false;
            
            if (state.currentChallenge && checkChallengeCompletion(distKm, state.elapsedTime)) {
                earnedXP += state.currentChallenge.reward;
                challengeComplete = true;
                confettiExplosion(); // Trigger Confetti
            }

            state.totalXP += earnedXP;
            
            const runData = {
                id: Date.now(),
                date: new Date().toISOString(),
                distance: state.distance,
                duration: state.elapsedTime,
                calories: state.calories,
                coords: [...state.coords],
                markers: [...state.markers],
                xp: earnedXP
            };
            
            state.runHistory.unshift(runData);
            saveData();

            // Prepare Summary UI
            ui.summaryDist.innerText = distKm.toFixed(2) + " km";
            ui.summaryTime.innerText = formatTime(state.elapsedTime);
            ui.summaryCals.innerText = state.calories;
            
            if(challengeComplete) {
                ui.challengeBox.classList.remove('hidden');
                ui.challengeBox.classList.add('flex');
                ui.bonusXp.innerText = state.currentChallenge.reward;
            } else {
                ui.challengeBox.classList.add('hidden');
                ui.challengeBox.classList.remove('flex');
            }

            // Route Visualization
            ui.uploadOverlay.style.display = 'flex'; // Show upload prompt
            drawRouteOnCanvas(null); // Draw route on black background initially

            document.querySelector('nav').style.display = 'flex'; // Show nav
            switchScreen('summary');
        }

        function updateRunState() {
            // Only update time if not paused
            if (!state.isAutoPaused) {
                // We use increment approach or date diff. Since we pause, simple increment is safer to avoid jumps.
                // However, date diff is more accurate for drift. 
                // Let's use a simple counter for simplicity in this paused-based context.
                state.elapsedTime += 1;
                ui.timer.innerText = formatTime(state.elapsedTime);
                
                // Calorie Calc: MET * Kg * Hours
                const hours = state.elapsedTime / 3600;
                state.calories = Math.floor(CONFIG.MET_RUNNING * state.userWeight * hours);
                ui.runCals.innerText = state.calories;
            }
        }

        // --- GPS HANDLERS ---
        function handlePositionSuccess(position) {
            const { latitude, longitude, accuracy, speed } = position.coords;

            // Signal UI
            if (accuracy < 20) {
                ui.gpsDot.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981]";
                ui.gpsText.innerText = state.isAutoPaused ? "AUTO-PAUSED" : "GPS LOCKED";
            } else {
                ui.gpsDot.className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
                ui.gpsText.innerText = "SEARCHING";
            }

            if (accuracy > 40) return; // Filter weak signals

            // AUTO PAUSE LOGIC
            // Use GPS speed if available, otherwise assume movement if we have distance
            // 0.8 m/s is roughly 2.8 km/h. Walking speed is ~1.4 m/s.
            let currentSpeed = speed;
            if (currentSpeed === null && state.lastPosition) {
                // Fallback calc if hardware speed is null
                // Note: accurate fallback requires precise timestamps which we can add later if needed
                // For now, if speed is null, we might skip auto-pause or be lenient.
                currentSpeed = 1.0; // Assume moving if no speed data to prevent false pause
            }

            if (currentSpeed !== null && currentSpeed < CONFIG.MIN_MOVEMENT_SPEED) {
                state.lowSpeedCounter++;
                // If low speed for 5 seconds, Pause
                if (state.lowSpeedCounter > 5 && !state.isAutoPaused) {
                    state.isAutoPaused = true;
                    // Visual feedback
                    ui.timer.classList.add('text-yellow-500');
                    ui.autoPauseIndicator.classList.remove('hidden');
                    ui.gpsText.innerText = "AUTO-PAUSED";
                }
            } else {
                // Moving
                state.lowSpeedCounter = 0;
                if (state.isAutoPaused) {
                    // RESUME
                    state.isAutoPaused = false;
                    ui.timer.classList.remove('text-yellow-500');
                    ui.autoPauseIndicator.classList.add('hidden');
                    ui.gpsText.innerText = "GPS LOCKED";
                }
            }

            // If paused, do not record distance/coords
            if (state.isAutoPaused) return;


            if (state.lastPosition) {
                const distIncrement = calculateDistance(
                    state.lastPosition.latitude, state.lastPosition.longitude,
                    latitude, longitude
                );

                if (distIncrement > 2) { // 2m threshold for jitter
                    state.distance += distIncrement;
                    
                    // 1KM FLAG LOGIC
                    const currentKm = Math.floor(state.distance / 1000);
                    if (currentKm > state.lastKmMarker) {
                        state.lastKmMarker = currentKm;
                        
                        // Add marker
                        state.markers.push({
                            lat: latitude,
                            lng: longitude,
                            label: currentKm
                        });

                        showToast(`ðŸš© ${currentKm} KM Milestone!`);
                    }
                }
            }

            state.lastPosition = { latitude, longitude };
            state.coords.push({ lat: latitude, lng: longitude });

            // UI Updates
            const distKm = state.distance / 1000;
            ui.runDist.innerText = distKm.toFixed(2);
            
            // Speed
            let kph = speed ? (speed * 3.6) : 0;
            ui.runSpeed.innerText = kph.toFixed(1);

            // Pace
            if (distKm > 0.05) {
                const paceMins = (state.elapsedTime / 60) / distKm;
                const pM = Math.floor(paceMins);
                const pS = Math.floor((paceMins - pM) * 60);
                ui.runPace.innerText = `${pM}:${pS.toString().padStart(2,'0')}`;
            }
        }

        function handlePositionError(err) {
            console.warn(err);
            ui.gpsText.innerText = "NO SIGNAL";
            ui.gpsDot.className = "w-2 h-2 rounded-full bg-red-500";
        }

        // --- CANVAS & ROUTE VISUALIZATION ---
        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    ui.uploadOverlay.style.display = 'none';
                    drawRouteOnCanvas(img);
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        function drawRouteOnCanvas(bgImage) {
            const ctx = ui.canvas.getContext('2d');
            const w = ui.canvas.width = 1080;
            const h = ui.canvas.height = 1350; // 4:5 aspect ratio

            // 1. Background
            if (bgImage) {
                // Cover fit
                const ratio = Math.max(w / bgImage.width, h / bgImage.height);
                const centerShift_x = (w - bgImage.width * ratio) / 2;
                const centerShift_y = (h - bgImage.height * ratio) / 2;
                ctx.drawImage(bgImage, 0, 0, bgImage.width, bgImage.height, centerShift_x, centerShift_y, bgImage.width * ratio, bgImage.height * ratio);
                
                // Dark overlay gradient
                const grad = ctx.createLinearGradient(0, h/2, 0, h);
                grad.addColorStop(0, "transparent");
                grad.addColorStop(0.8, "rgba(0,0,0,0.85)");
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, w, h);
            } else {
                ctx.fillStyle = "#0f172a";
                ctx.fillRect(0, 0, w, h);
                // Grid pattern
                ctx.strokeStyle = "#1e293b";
                ctx.lineWidth = 2;
                for(let i=0; i<w; i+=100) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,h); ctx.stroke(); }
                for(let i=0; i<h; i+=100) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(w,i); ctx.stroke(); }
            }

            // 2. Draw Route Path
            if (state.coords.length > 1) {
                // Normalize coordinates to canvas
                let minLat = Infinity, maxLat = -Infinity, minLng = Infinity, maxLng = -Infinity;
                state.coords.forEach(c => {
                    if (c.lat < minLat) minLat = c.lat;
                    if (c.lat > maxLat) maxLat = c.lat;
                    if (c.lng < minLng) minLng = c.lng;
                    if (c.lng > maxLng) maxLng = c.lng;
                });

                const padding = 200;
                const availW = w - (padding*2);
                const availH = (h/2) - padding; // Use top half
                
                const latRange = maxLat - minLat || 1;
                const lngRange = maxLng - minLng || 1;
                
                // Scale to fit
                const scale = Math.min(availW / lngRange, availH / latRange);

                ctx.beginPath();
                ctx.strokeStyle = "#10b981"; // Emerald
                ctx.lineWidth = 15;
                ctx.lineCap = "round";
                ctx.lineJoin = "round";
                ctx.shadowColor = "#10b981";
                ctx.shadowBlur = 20;

                state.coords.forEach((c, i) => {
                    // Mercator projection simplified
                    const x = padding + (c.lng - minLng) * scale;
                    const y = (h * 0.4) - (c.lat - minLat) * scale; // Flip Y
                    if (i===0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.shadowBlur = 0; // Reset

                // 2.5 Draw Markers
                if(state.markers && state.markers.length > 0) {
                    state.markers.forEach(m => {
                        const x = padding + (m.lng - minLng) * scale;
                        const y = (h * 0.4) - (m.lat - minLat) * scale;

                        // Draw Pole
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(x, y - 50);
                        ctx.lineWidth = 4;
                        ctx.strokeStyle = "white";
                        ctx.stroke();

                        // Draw Flag
                        ctx.beginPath();
                        ctx.moveTo(x, y - 50);
                        ctx.lineTo(x + 40, y - 35);
                        ctx.lineTo(x, y - 20);
                        ctx.fillStyle = "#f59e0b"; // Amber
                        ctx.fill();
                        
                        // Text
                        ctx.fillStyle = "white";
                        ctx.font = "bold 24px Inter";
                        ctx.textAlign = "center";
                        ctx.fillText(m.label + "k", x, y + 30);
                        ctx.textAlign = "left"; // reset
                    });
                }
            }

            // 3. Stats Text
            ctx.fillStyle = "white";
            ctx.font = "bold 160px Inter, sans-serif";
            const distTxt = (state.distance / 1000).toFixed(2);
            ctx.fillText(distTxt, 80, h - 350);
            
            ctx.font = "bold 60px Inter, sans-serif";
            ctx.fillStyle = "#10b981";
            ctx.fillText("KILOMETERS", 80, h - 280);

            // Metrics Row
            ctx.fillStyle = "#cbd5e1";
            ctx.font = "50px Inter, sans-serif";
            const timeTxt = formatTime(state.elapsedTime);
            const calTxt = state.calories + " Kcal";
            ctx.fillText(`${timeTxt} Duration  â€¢  ${calTxt}`, 80, h - 180);

            // Branding
            ctx.textAlign = "right";
            ctx.font = "bold 40px Inter, sans-serif";
            ctx.fillStyle = "rgba(255,255,255,0.5)";
            ctx.fillText("STRIDEQUEST", w - 80, 100);
            ctx.textAlign = "left"; // Reset

            // Enable download
            ui.btnDownload.disabled = false;
            document.getElementById('btn-download').classList.remove('opacity-50', 'cursor-not-allowed');
        }

        function downloadCard() {
            const link = document.createElement('a');
            link.download = `stride_${Date.now()}.png`;
            link.href = ui.canvas.toDataURL();
            link.click();
        }

        // --- UTILITIES & LOGIC ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        function generateDailyChallenge() {
            const today = new Date().toDateString();
            let c = JSON.parse(localStorage.getItem('sq_challenge'));
            
            if (!c || c.date !== today) {
                const types = ['dist', 'time'];
                const type = types[Math.floor(Math.random()*types.length)];
                
                if (type === 'dist') {
                    const target = 2000 + Math.floor(Math.random() * 3000); // 2-5km
                    c = { date: today, type, target, reward: 100, desc: `Run ${(target/1000).toFixed(1)}km` };
                } else {
                    const target = 15 * 60; // 15 mins
                    c = { date: today, type, target, reward: 150, desc: `Run for 15 mins` };
                }
                localStorage.setItem('sq_challenge', JSON.stringify(c));
            }
            state.currentChallenge = c;
            ui.challengeText.innerText = c.desc;
            ui.challengeReward.innerText = c.reward + " XP";
        }

        function checkChallengeCompletion(distKm, timeSec) {
            const c = state.currentChallenge;
            if (c.type === 'dist') return (distKm * 1000) >= c.target;
            if (c.type === 'time') return timeSec >= c.target;
            return false;
        }

        // --- PERSISTENCE ---
        function loadData() {
            state.runHistory = JSON.parse(localStorage.getItem('sq_history') || '[]');
            state.totalXP = parseInt(localStorage.getItem('sq_xp') || '0');
            state.userWeight = parseInt(localStorage.getItem('sq_weight') || '70');
            state.userName = localStorage.getItem('sq_name') || 'Runner';
        }

        function saveData() {
            localStorage.setItem('sq_history', JSON.stringify(state.runHistory));
            localStorage.setItem('sq_xp', state.totalXP);
        }

        function saveProfile() {
            state.userName = ui.inputName.value || 'Runner';
            state.userWeight = parseInt(ui.inputWeight.value) || 70;
            localStorage.setItem('sq_name', state.userName);
            localStorage.setItem('sq_weight', state.userWeight);
            alert("Profile Saved!");
        }

        function loadProfileUI() {
            ui.inputName.value = state.userName;
            ui.inputWeight.value = state.userWeight;
            ui.profileRuns.innerText = state.runHistory.length;
            ui.profileXp.innerText = state.totalXP;
        }

        function updateDashboard() {
            ui.xp.innerText = state.totalXP;
            const totalM = state.runHistory.reduce((a,r) => a + r.distance, 0);
            ui.totalDist.innerText = (totalM/1000).toFixed(1);
            const totalC = state.runHistory.reduce((a,r) => a + (r.calories||0), 0);
            ui.totalCals.innerText = totalC;

            ui.historyList.innerHTML = state.runHistory.slice(0,5).map(r => `
                <div class="glass p-4 rounded-xl flex justify-between items-center border border-white/5 relative group">
                    <div class="flex items-center gap-3">
                        <div class="bg-emerald-500/20 p-2 rounded-lg text-emerald-400">
                            <i data-lucide="activity" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <div class="font-bold text-white">${(r.distance/1000).toFixed(2)} km</div>
                            <div class="text-[10px] text-slate-500 uppercase font-bold">${new Date(r.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="text-right mr-6">
                        <div class="font-mono text-indigo-300 font-bold">${formatTime(r.duration)}</div>
                        <div class="text-xs text-slate-500">${r.calories || 0} cal</div>
                    </div>
                    
                    <button onclick="event.stopPropagation(); window.deleteRun('${r.id || 0}')" class="absolute top-1/2 -translate-y-1/2 right-2 p-2 text-slate-500 hover:text-red-400 hover:bg-white/5 rounded-full transition-all z-20 cursor-pointer">
                        <i data-lucide="x" class="w-4 h-4 pointer-events-none"></i>
                    </button>
                </div>
            `).join('');
            
            // Re-render icons for new list items
            lucide.createIcons();
        }

        // Add Delete function to window scope
        window.deleteRun = function(id) {
            // Remove confirm() as it can be blocked. Using immediate delete with toast feedback.
            // Converting to string for safe comparison in case IDs are mixed types
            state.runHistory = state.runHistory.filter(r => String(r.id) !== String(id));
            saveData();
            updateDashboard();
            showToast("Run deleted");
        };

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try { state.wakeLock = await navigator.wakeLock.request('screen'); } 
                catch (err) { console.log(err); }
            }
        }

        // --- CONFETTI EFFECT ---
        function confettiExplosion() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = [];
            const particleCount = 100;
            const colors = ['#10b981', '#8b5cf6', '#f59e0b', '#3b82f6'];

            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    w: Math.random() * 10 + 5,
                    h: Math.random() * 10 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 0.5) * 20,
                    gravity: 0.5,
                    life: 100
                });
            }

            function update() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach((p, i) => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += p.gravity;
                    p.life--;
                    p.w *= 0.95;
                    p.h *= 0.95;

                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.w, p.h);

                    if (p.life <= 0) particles.splice(i, 1);
                });

                if (particles.length > 0) requestAnimationFrame(update);
                else ctx.clearRect(0,0, canvas.width, canvas.height);
            }
            update();
        }

        // Start App
        init();

    </script>
</body>
</html>